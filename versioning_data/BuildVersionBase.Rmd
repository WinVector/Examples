---
title: "build versioned db"
output: html_document
date: "2024-09-19"
---


```{r}
library(DBI)
source("pull_data_by_use.R")
```

```{r}
con <- dbConnect(RSQLite::SQLite(), "movie_data.sqlite")
```

```{r}
# read our data
d_before_August_orig <- read.csv(
  'Roxie_schedule_as_known_before_August.csv', 
  strip.white = TRUE, 
  stringsAsFactors = FALSE)
d_before_August_orig$Attendance <- d_before_August_orig$EstimatedAttendance
d_before_August_orig$EstimatedAttendance <- NULL
d_before_August <- d_before_August_orig
# d_before_August$Date <- as.Date(d_before_August$Date)
d_before_August$`_usi` <- 1337
d_after_August_orig <- read.csv(
  'Roxie_schedule_as_known_after_August.csv', 
  strip.white = TRUE, 
  stringsAsFactors = FALSE)
d_after_August <- d_after_August_orig
# d_after_August$Date <- as.Date(d_after_August$Date)
d_after_August$`_usi` <- 1338
d <- rbind(d_before_August, d_after_August)
orig_cols <- colnames(d_before_August_orig)
```

```{r}
dbWriteTable(con, 'd_raw', d, overwrite=TRUE)
```

```{r}
# scan data getting newest version of each unique record
# using the fact we know that only attendance changed
# updates from external snapshots with few constraints would be harder
res <- dbGetQuery(con, "
WITH 
fact_id_scan AS (
   SELECT
     Date,
     Time,
     Movie,
     87776 + SUM(1) OVER(ORDER BY Date, Time, Movie) AS _fi
   FROM 
     d_raw
   GROUP BY
     Date,
     Time,
     Movie
),
usi_scan AS (
   SELECT
     MIN(_usi) AS _usi,
     Date,
     Time,
     Movie,
     Attendance
   FROM 
     d_raw
   GROUP BY
     Date,
     Time,
     Movie,
     Attendance
)
SELECT
    fact_id_scan._fi AS _fi,
    usi_scan.*
  FROM 
    usi_scan
  LEFT JOIN
    fact_id_scan
  ON
    usi_scan.Date = fact_id_scan.Date
    AND usi_scan.Time = fact_id_scan.Time
    AND usi_scan.Movie = fact_id_scan.Movie
  ORDER BY
     usi_scan.Date,
     usi_scan.Time,
     usi_scan.Movie,
     fact_id_scan._fi,
     usi_scan._usi,
     usi_scan.Attendance
")
dbRemoveTable(con, 'd_raw')
```

```{r}
dbWriteTable(con, 'd_data_log', res, overwrite=TRUE)
head(dbGetQuery(con, "SELECT * from d_data_log"))
```

```{r}
update_log <- data.frame(
  `_usi` = c(1212, 1337, 1338),
  `_update_time` = c('2024-06-12 18:45:15Z', '2024-08-02 23:45:15Z', '2024-09-03 22:12:00Z'),
  note = c('mal-formatted records removed', 'after July 2024 data refresh', 'after August 2024 data refresh'),
  as_of_date = c('2024-05-31', '2024-07-31', '2024-08-31'),
  check.names = FALSE
)
dbWriteTable(con, 'update_log', update_log, overwrite=TRUE)
head(dbGetQuery(con, "SELECT * from update_log"))
```

```{r}
d_row_deletions <- data.frame(
  `_usi` = c(1212, 1212),
  `_fi` = c(3312, 3313),
  check.names = FALSE
)
dbWriteTable(con, 'd_row_deletions', d_row_deletions, overwrite=TRUE)
head(dbGetQuery(con, "SELECT * from d_row_deletions"))
```


```{r}
d_before_August_view <- pull_data_by_usi(con, 1337)
```


```{r}
head(d_before_August_view)
```

```{r}
tail(d_before_August_view)
```

```{r}
d_after_August_view <- pull_data_by_usi(con, 1338)
```


```{r}
head(d_after_August_view)
```


```{r}
tail(d_after_August_view)
```


```{r}
# confirm equivalent
equivalent_data_frames <- function(a, b) {
  if(!(all(dim(a) == dim(b)))) {
    return(FALSE)
  }
  cols <- sort(colnames(a))
  if(!all(cols == sort(colnames(b)))) {
    return(FALSE)
  }
  a <- a[, cols, drop=FALSE]
  b <- b[, cols, drop=FALSE]
  a <- a[do.call(order, a), , drop = FALSE]
  b <- b[do.call(order, b), , drop = FALSE]
  return(all(a==b))
}
```

```{r}

stopifnot(equivalent_data_frames(d_before_August_orig, d_before_August_view[ , orig_cols]))
stopifnot(equivalent_data_frames(d_after_August_orig, d_after_August_view[ , orig_cols]))
```


```{r}
dbDisconnect(con)
```

