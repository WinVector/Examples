

// model_style: independent means
functions {
  vector shift_scale(vector v, real target_mean, real target_var) {
     // shift and scale v to match target mean and variances
     int n = dims(v)[1];
     vector[n] vc = v - mean(v);  // shift to mean zero
     vc = vc / sqrt(dot_product(vc, vc));  // normalize
     real scale = sqrt((n - 1) * target_var);
     real shift = target_mean;
     vc = scale * vc + shift;  // move to desired man and variance
     if ((abs(mean(vc) - target_mean) >= 1e-3) || (abs(variance(vc) - target_var) >= 1e-3)) {
        reject("shift/scale failed");
     }
     return vc;
  }
}
data {
  int<lower=1> n_studies;  // number of studies
  array[n_studies] int<lower=1> nE;  // number treated examples
  vector[n_studies] meanE;  // mean observed treatment effect
  vector<lower=0>[n_studies] varE;  // observed treatment effect variance
  array[n_studies] int<lower=1> nC;  // number control examples
  vector[n_studies] meanC;  // mean observed control effect
  vector<lower=0>[n_studies] varC;  // observed control effect variance
}
parameters {
  vector[n_studies] inferred_group_treatment_mean;  // unobserved per-group ideal treatment effect
  vector[n_studies] inferred_group_control_mean;  // unobserved per-group ideal treatment effect
  vector<lower=0>[n_studies] inferred_in_group_stddev;  // unobserved per-group treatment variance

  vector[nE[1]] treatment_subject_unscaled_1;  // unobserved per-group and subject treatment effects (unscaled)
  vector[nC[1]] control_subject_unscaled_1;  // unobserved per-group and subject control effects (unscaled)


  vector[nE[2]] treatment_subject_unscaled_2;  // unobserved per-group and subject treatment effects (unscaled)
  vector[nC[2]] control_subject_unscaled_2;  // unobserved per-group and subject control effects (unscaled)


  vector[nE[3]] treatment_subject_unscaled_3;  // unobserved per-group and subject treatment effects (unscaled)
  vector[nC[3]] control_subject_unscaled_3;  // unobserved per-group and subject control effects (unscaled)


  vector[nE[4]] treatment_subject_unscaled_4;  // unobserved per-group and subject treatment effects (unscaled)
  vector[nC[4]] control_subject_unscaled_4;  // unobserved per-group and subject control effects (unscaled)


  vector[nE[5]] treatment_subject_unscaled_5;  // unobserved per-group and subject treatment effects (unscaled)
  vector[nC[5]] control_subject_unscaled_5;  // unobserved per-group and subject control effects (unscaled)


  vector[nE[6]] treatment_subject_unscaled_6;  // unobserved per-group and subject treatment effects (unscaled)
  vector[nC[6]] control_subject_unscaled_6;  // unobserved per-group and subject control effects (unscaled)


  vector[nE[7]] treatment_subject_unscaled_7;  // unobserved per-group and subject treatment effects (unscaled)
  vector[nC[7]] control_subject_unscaled_7;  // unobserved per-group and subject control effects (unscaled)


  vector[nE[8]] treatment_subject_unscaled_8;  // unobserved per-group and subject treatment effects (unscaled)
  vector[nC[8]] control_subject_unscaled_8;  // unobserved per-group and subject control effects (unscaled)

}
transformed parameters {

  vector[nE[1]] treatment_subject_1;  // unobserved per-group and subject treatment effects
  vector[nC[1]] control_subject_1;  // unobserved per-group and subject control effects


  vector[nE[2]] treatment_subject_2;  // unobserved per-group and subject treatment effects
  vector[nC[2]] control_subject_2;  // unobserved per-group and subject control effects


  vector[nE[3]] treatment_subject_3;  // unobserved per-group and subject treatment effects
  vector[nC[3]] control_subject_3;  // unobserved per-group and subject control effects


  vector[nE[4]] treatment_subject_4;  // unobserved per-group and subject treatment effects
  vector[nC[4]] control_subject_4;  // unobserved per-group and subject control effects


  vector[nE[5]] treatment_subject_5;  // unobserved per-group and subject treatment effects
  vector[nC[5]] control_subject_5;  // unobserved per-group and subject control effects


  vector[nE[6]] treatment_subject_6;  // unobserved per-group and subject treatment effects
  vector[nC[6]] control_subject_6;  // unobserved per-group and subject control effects


  vector[nE[7]] treatment_subject_7;  // unobserved per-group and subject treatment effects
  vector[nC[7]] control_subject_7;  // unobserved per-group and subject control effects


  vector[nE[8]] treatment_subject_8;  // unobserved per-group and subject treatment effects
  vector[nC[8]] control_subject_8;  // unobserved per-group and subject control effects

  treatment_subject_1 = shift_scale(treatment_subject_unscaled_1, meanE[1], varE[1]);
  control_subject_1 = shift_scale(control_subject_unscaled_1, meanC[1], varC[1]);


  treatment_subject_2 = shift_scale(treatment_subject_unscaled_2, meanE[2], varE[2]);
  control_subject_2 = shift_scale(control_subject_unscaled_2, meanC[2], varC[2]);


  treatment_subject_3 = shift_scale(treatment_subject_unscaled_3, meanE[3], varE[3]);
  control_subject_3 = shift_scale(control_subject_unscaled_3, meanC[3], varC[3]);


  treatment_subject_4 = shift_scale(treatment_subject_unscaled_4, meanE[4], varE[4]);
  control_subject_4 = shift_scale(control_subject_unscaled_4, meanC[4], varC[4]);


  treatment_subject_5 = shift_scale(treatment_subject_unscaled_5, meanE[5], varE[5]);
  control_subject_5 = shift_scale(control_subject_unscaled_5, meanC[5], varC[5]);


  treatment_subject_6 = shift_scale(treatment_subject_unscaled_6, meanE[6], varE[6]);
  control_subject_6 = shift_scale(control_subject_unscaled_6, meanC[6], varC[6]);


  treatment_subject_7 = shift_scale(treatment_subject_unscaled_7, meanE[7], varE[7]);
  control_subject_7 = shift_scale(control_subject_unscaled_7, meanC[7], varC[7]);


  treatment_subject_8 = shift_scale(treatment_subject_unscaled_8, meanE[8], varE[8]);
  control_subject_8 = shift_scale(control_subject_unscaled_8, meanC[8], varC[8]);

}
model {
  // priors
  inferred_group_treatment_mean ~ normal(0, 1);
  inferred_group_control_mean ~ normal(0, 1);
  inferred_in_group_stddev ~ lognormal(0, 1);
  // more peaked/informative stuff

  // each group generates an unobserved treatment response
  // inputs to sample generation
  treatment_subject_1 ~ normal(0, 1);  // pre-image of uniform on 1.x = 0, x.x = 1 shell
  // treatment subjects experience effects a function of unobserved group response
  // in the normal distribution case could avoid forming individual observations as we know
  // summary mean should be normally distributed and variance chi-square (with proper parameters and scaling)
  treatment_subject_1 ~ normal(inferred_group_treatment_mean[1], inferred_in_group_stddev[1]);
  // each group generates an unobserved control response
  // inputs to sample generation
  control_subject_1 ~ normal(0, 1);  // pre-image of uniform on 1.x = 0, x.x = 1 shell
  // control subjects experience effects a function of unobserved group response
  // in the normal distribution case could avoid forming individual observations as we know
  // summary mean should be normally distributed and variance chi-square (with proper parameters and scaling)
  control_subject_1 ~ normal(inferred_group_control_mean[1], inferred_in_group_stddev[1]);


  // each group generates an unobserved treatment response
  // inputs to sample generation
  treatment_subject_2 ~ normal(0, 1);  // pre-image of uniform on 1.x = 0, x.x = 1 shell
  // treatment subjects experience effects a function of unobserved group response
  // in the normal distribution case could avoid forming individual observations as we know
  // summary mean should be normally distributed and variance chi-square (with proper parameters and scaling)
  treatment_subject_2 ~ normal(inferred_group_treatment_mean[2], inferred_in_group_stddev[2]);
  // each group generates an unobserved control response
  // inputs to sample generation
  control_subject_2 ~ normal(0, 1);  // pre-image of uniform on 1.x = 0, x.x = 1 shell
  // control subjects experience effects a function of unobserved group response
  // in the normal distribution case could avoid forming individual observations as we know
  // summary mean should be normally distributed and variance chi-square (with proper parameters and scaling)
  control_subject_2 ~ normal(inferred_group_control_mean[2], inferred_in_group_stddev[2]);


  // each group generates an unobserved treatment response
  // inputs to sample generation
  treatment_subject_3 ~ normal(0, 1);  // pre-image of uniform on 1.x = 0, x.x = 1 shell
  // treatment subjects experience effects a function of unobserved group response
  // in the normal distribution case could avoid forming individual observations as we know
  // summary mean should be normally distributed and variance chi-square (with proper parameters and scaling)
  treatment_subject_3 ~ normal(inferred_group_treatment_mean[3], inferred_in_group_stddev[3]);
  // each group generates an unobserved control response
  // inputs to sample generation
  control_subject_3 ~ normal(0, 1);  // pre-image of uniform on 1.x = 0, x.x = 1 shell
  // control subjects experience effects a function of unobserved group response
  // in the normal distribution case could avoid forming individual observations as we know
  // summary mean should be normally distributed and variance chi-square (with proper parameters and scaling)
  control_subject_3 ~ normal(inferred_group_control_mean[3], inferred_in_group_stddev[3]);


  // each group generates an unobserved treatment response
  // inputs to sample generation
  treatment_subject_4 ~ normal(0, 1);  // pre-image of uniform on 1.x = 0, x.x = 1 shell
  // treatment subjects experience effects a function of unobserved group response
  // in the normal distribution case could avoid forming individual observations as we know
  // summary mean should be normally distributed and variance chi-square (with proper parameters and scaling)
  treatment_subject_4 ~ normal(inferred_group_treatment_mean[4], inferred_in_group_stddev[4]);
  // each group generates an unobserved control response
  // inputs to sample generation
  control_subject_4 ~ normal(0, 1);  // pre-image of uniform on 1.x = 0, x.x = 1 shell
  // control subjects experience effects a function of unobserved group response
  // in the normal distribution case could avoid forming individual observations as we know
  // summary mean should be normally distributed and variance chi-square (with proper parameters and scaling)
  control_subject_4 ~ normal(inferred_group_control_mean[4], inferred_in_group_stddev[4]);


  // each group generates an unobserved treatment response
  // inputs to sample generation
  treatment_subject_5 ~ normal(0, 1);  // pre-image of uniform on 1.x = 0, x.x = 1 shell
  // treatment subjects experience effects a function of unobserved group response
  // in the normal distribution case could avoid forming individual observations as we know
  // summary mean should be normally distributed and variance chi-square (with proper parameters and scaling)
  treatment_subject_5 ~ normal(inferred_group_treatment_mean[5], inferred_in_group_stddev[5]);
  // each group generates an unobserved control response
  // inputs to sample generation
  control_subject_5 ~ normal(0, 1);  // pre-image of uniform on 1.x = 0, x.x = 1 shell
  // control subjects experience effects a function of unobserved group response
  // in the normal distribution case could avoid forming individual observations as we know
  // summary mean should be normally distributed and variance chi-square (with proper parameters and scaling)
  control_subject_5 ~ normal(inferred_group_control_mean[5], inferred_in_group_stddev[5]);


  // each group generates an unobserved treatment response
  // inputs to sample generation
  treatment_subject_6 ~ normal(0, 1);  // pre-image of uniform on 1.x = 0, x.x = 1 shell
  // treatment subjects experience effects a function of unobserved group response
  // in the normal distribution case could avoid forming individual observations as we know
  // summary mean should be normally distributed and variance chi-square (with proper parameters and scaling)
  treatment_subject_6 ~ normal(inferred_group_treatment_mean[6], inferred_in_group_stddev[6]);
  // each group generates an unobserved control response
  // inputs to sample generation
  control_subject_6 ~ normal(0, 1);  // pre-image of uniform on 1.x = 0, x.x = 1 shell
  // control subjects experience effects a function of unobserved group response
  // in the normal distribution case could avoid forming individual observations as we know
  // summary mean should be normally distributed and variance chi-square (with proper parameters and scaling)
  control_subject_6 ~ normal(inferred_group_control_mean[6], inferred_in_group_stddev[6]);


  // each group generates an unobserved treatment response
  // inputs to sample generation
  treatment_subject_7 ~ normal(0, 1);  // pre-image of uniform on 1.x = 0, x.x = 1 shell
  // treatment subjects experience effects a function of unobserved group response
  // in the normal distribution case could avoid forming individual observations as we know
  // summary mean should be normally distributed and variance chi-square (with proper parameters and scaling)
  treatment_subject_7 ~ normal(inferred_group_treatment_mean[7], inferred_in_group_stddev[7]);
  // each group generates an unobserved control response
  // inputs to sample generation
  control_subject_7 ~ normal(0, 1);  // pre-image of uniform on 1.x = 0, x.x = 1 shell
  // control subjects experience effects a function of unobserved group response
  // in the normal distribution case could avoid forming individual observations as we know
  // summary mean should be normally distributed and variance chi-square (with proper parameters and scaling)
  control_subject_7 ~ normal(inferred_group_control_mean[7], inferred_in_group_stddev[7]);


  // each group generates an unobserved treatment response
  // inputs to sample generation
  treatment_subject_8 ~ normal(0, 1);  // pre-image of uniform on 1.x = 0, x.x = 1 shell
  // treatment subjects experience effects a function of unobserved group response
  // in the normal distribution case could avoid forming individual observations as we know
  // summary mean should be normally distributed and variance chi-square (with proper parameters and scaling)
  treatment_subject_8 ~ normal(inferred_group_treatment_mean[8], inferred_in_group_stddev[8]);
  // each group generates an unobserved control response
  // inputs to sample generation
  control_subject_8 ~ normal(0, 1);  // pre-image of uniform on 1.x = 0, x.x = 1 shell
  // control subjects experience effects a function of unobserved group response
  // in the normal distribution case could avoid forming individual observations as we know
  // summary mean should be normally distributed and variance chi-square (with proper parameters and scaling)
  control_subject_8 ~ normal(inferred_group_control_mean[8], inferred_in_group_stddev[8]);

}

